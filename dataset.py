# -*- coding: utf-8 -*-
"""dataset.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1L4m5hriDCDJGceBGBP6SN0WbYgERVEov
"""

import deepchem as dc
import pandas as pd
import numpy as np
from rdkit import Chem

def get_tox21_datasets():
    print("Processing Tox21 data...")
    url = "https://deepchemdata.s3-us-west-1.amazonaws.com/datasets/tox21.csv.gz"
    df = pd.read_csv(url)

    tasks = [
        'NR-AR', 'NR-AR-LBD', 'NR-AhR', 'NR-Aromatase', 'NR-ER', 'NR-ER-LBD',
        'NR-PPAR-gamma', 'SR-ARE', 'SR-ATAD5', 'SR-HSE', 'SR-MMP', 'SR-p53'
    ]

    # Filter invalid SMILES
    def is_valid(s):
        try:
            return Chem.MolFromSmiles(s) is not None
        except:
            return False

    smiles_col = 'smiles' if 'smiles' in df.columns else 'SMILES'
    df = df[df[smiles_col].apply(is_valid)].reset_index(drop=True)

    # Format for Multi-Task Training
    records = []
    for _, row in df.iterrows():
        smi = row[smiles_col]
        for t in tasks:
            lbl = row[t]
            if pd.notna(lbl):
                # Prompt: Molecule + Task -> Label
                txt = f"Molecule: {smi} Task: {t} \nIs Toxic: {int(lbl)}"
                records.append({'smiles': smi, 'prompt': txt, 'label': int(lbl)})

    df_proc = pd.DataFrame(records)

    # Handle Imbalance (3x Oversampling for Positives)
    pos = df_proc[df_proc['label'] == 1]
    neg = df_proc[df_proc['label'] == 0]
    df_bal = pd.concat([neg] + [pos]*3).sample(frac=1, random_state=42).reset_index(drop=True)

    print(f"Dataset Size (Balanced): {len(df_bal)}")

    # DeepChem Dataset Creation
    dataset = dc.data.NumpyDataset(
        X=df_bal['prompt'].values,
        y=df_bal['label'].values,
        ids=df_bal['smiles'].values
    )

    # Scaffold Split
    print("Splitting data (Scaffold)...")
    splitter = dc.splits.ScaffoldSplitter()
    train_ds, valid_ds, test_ds = splitter.train_valid_test_split(dataset)

    print(f"Train: {len(train_ds)} | Valid: {len(valid_ds)}")
    return train_ds, valid_ds, test_ds